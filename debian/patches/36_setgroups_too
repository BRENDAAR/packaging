setgroups() before setgid/setuid/home
Author: Mario Limonciello <superm1@ubuntu.com>

---
--- mythtv-0.23.0~trunk23567.orig/programs/mythbackend/main.cpp
+++ mythtv-0.23.0~trunk23567/programs/mythbackend/main.cpp
@@ -7,6 +7,7 @@
 #include <libgen.h>
 #include <signal.h>
 #include <pwd.h>
+#include <grp.h>
 
 #include "mythconfig.h"
 #if CONFIG_DARWIN
@@ -878,6 +879,34 @@ int main(int argc, char **argv)
         }
         else if (!user_id && user_info)
         {
+            int ngroups = 1;
+            gid_t *groups;
+            groups = (gid_t*) malloc(ngroups * sizeof (gid_t));
+            if (groups == NULL)
+            {
+                VERBOSE(VB_IMPORTANT,
+                        QString("Error allocating memory for %1 groups.").arg(ngroups));
+                return BACKEND_EXIT_PERMISSIONS_ERROR;
+            }
+            if (getgrouplist(user_info->pw_name, user_info->pw_gid, groups, &ngroups) == -1)
+            {
+                free(groups);
+                groups = (gid_t*) malloc(ngroups * sizeof (gid_t));
+                if (groups == NULL)
+                {
+                    VERBOSE(VB_IMPORTANT,
+                            QString("Error allocating memory for %1 groups.").arg(ngroups));
+                    return BACKEND_EXIT_PERMISSIONS_ERROR;
+                }
+                getgrouplist(user_info->pw_name, user_info->pw_gid, groups, &ngroups);
+            }
+            if (setgroups(sizeof(groups), groups) == -1)
+            {
+                free(groups);
+                VERBOSE(VB_IMPORTANT, "Error setting groups.");
+                return BACKEND_EXIT_PERMISSIONS_ERROR;
+            }
+            free(groups);
             if (setenv("HOME", user_info->pw_dir,1) == -1)
             {
                 VERBOSE(VB_IMPORTANT, "Error setting home directory.");
